name: Process Form Requests

on:
  push:
    paths:
      - 'form-submissions/*.json'

jobs:
  send-to-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get new submissions
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: 'form-submissions/*.json'

      - name: Process each submission
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Processing $file"
            
            # Extract form data
            DATA=$(jq -r '@base64d' "$file" | jq -c .)
            DISCORD=$(echo "$DATA" | jq -r '.discord')
            TOPIC=$(echo "$DATA" | jq -r '.topic')
            DETAILS=$(echo "$DATA" | jq -r '.details')
            IMAGE_URL=$(echo "$DATA" | jq -r '.referenceImage')

            curl -X POST \
              "${{ secrets.DISCORD_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d @- <<EOF
            {
              "embeds": [{
                "title": "ðŸ“¦ New Model Request",
                "color": 5814783,
                "fields": [
                  { "name": "ðŸ‘¤ Discord", "value": "$DISCORD", "inline": true },
                  { "name": "ðŸŽ¯ Topic", "value": "$TOPIC", "inline": true },
                  { "name": "ðŸ“ Details", "value": "$DETAILS" },
                  { "name": "ðŸ–¼ï¸ Reference", "value": "[View Image]($IMAGE_URL)" }
                ],
                "footer": { "text": "Submitted via GitHub Form" }
              }]
            }
            EOF

            git rm "$file"
          done

          # Commit changes
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git commit -m "Remove processed submissions" || echo "No changes to commit"
          git push
