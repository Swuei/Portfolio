name: Admin Token Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

permissions:
  contents: write
  actions: write

jobs:
  generate-token:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate token
        id: generate
        run: |
          TOKEN=$(openssl rand -hex 40)
          EXPIRY=$(date -u -d "55 minutes" '+%Y-%m-%dT%H:%M:%SZ')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "expiry=$EXPIRY" >> $GITHUB_OUTPUT
          echo "message=ðŸ›¡ï¸ **New Admin Token**\n\nðŸ”‘ Token: \`$TOKEN\`\nâ³ Expires: $EXPIRY" >> $GITHUB_OUTPUT

      - name: Encrypt expiry and save
        run: |
          mkdir -p .github
          echo "${{ steps.generate.outputs.expiry }}" | \
            openssl enc -aes-256-cbc -base64 -pbkdf2 -pass pass:"${{ secrets.EXPIRY_ENCRYPTION_KEY }}" > .github/expiry.enc

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .github/expiry.enc
          git commit -m "Update encrypted expiry" || echo "No changes to commit"
          git push

      - name: Send to Discord via curl
        run: |
          PAYLOAD=$(jq -n --arg msg "${{ steps.generate.outputs.message }}" '{content: $msg}')
          curl -s -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
