document.addEventListener("DOMContentLoaded",function(){console.log("Admin panel initialized successfully");const e="Swuei/Portfolio",t=`https://api.github.com/repos/${e}/actions/workflows/token-validation.yml/dispatches`,n=document.getElementById("adminBtn"),o=document.getElementById("adminModal"),i=document.querySelector(".admin-close-btn"),a=document.getElementById("loginForm"),s=document.getElementById("entryForm"),l=document.getElementById("loginBtn"),r=document.getElementById("submitEntryBtn"),c=document.getElementById("statusNotification"),d=document.getElementById("logoutBtn");function m(){const e=localStorage.getItem("adminSecret");let t=localStorage.getItem("tokenExpiry");if(e&&t){const e=new Date(t).toISOString().replace(/\.\d{3}Z$/,"Z");if(new Date(e)>new Date)return a.style.display="none",s.style.display="block",void(n&&(n.style.display="flex"))}localStorage.removeItem("adminSecret"),localStorage.removeItem("tokenExpiry"),a.style.display="block",s.style.display="none"}function u(e,t="info"){c&&(c.textContent=e,c.className=`status-notification ${t}`,c.style.display="block",setTimeout(()=>{c.style.display="none"},5e3))}n&&o&&(n.addEventListener("click",function(e){e.preventDefault(),o.style.display="flex",document.body.style.overflow="hidden",m()}),i.addEventListener("click",function(){o.style.display="none",document.body.style.overflow=""}),window.addEventListener("click",function(e){e.target===o&&(o.style.display="none",document.body.style.overflow="")})),m(),l&&l.addEventListener("click",async()=>{const n=document.getElementById("githubToken").value.trim(),o=document.getElementById("tokenExpiry").value.trim();if(!n||!o)return void u("Please enter both token and expiry","error");const i=new Date(o);if(isNaN(i.getTime()))return void u("Invalid expiry format","error");const a=i.toISOString().replace(/\.\d{3}Z$/,"Z");try{const o=await fetch(t,{method:"POST",headers:{Authorization:`Bearer ${n}`,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify({ref:"main",inputs:{token:n,expiry:a}})});if(204!==o.status)throw new Error(`Dispatch failed: HTTP ${o.status}`);u("Validation in progress… please wait","info");const i=e.split("/"),[s,l]=i,r="token-validation.yml";let c=null;const d=Date.now(),y=6e4,g=3e3;for(;Date.now()-d<y;){await new Promise(e=>setTimeout(e,g));const e=await fetch(`https://api.github.com/repos/${s}/${l}/actions/workflows/${r}/runs?event=workflow_dispatch`,{headers:{Authorization:`Bearer ${n}`,Accept:"application/vnd.github.v3+json"}}).then(e=>e.json()),t=e.workflow_runs&&e.workflow_runs[0];if(t&&["completed","failure","success"].includes(t.status)){c=t.conclusion;break}}if("success"!==c)throw new Error("Validation failed or timed out");localStorage.setItem("adminSecret",n),localStorage.setItem("tokenExpiry",a),m(),u("✅ Access granted","success")}catch(e){console.error(e),u(e.message||"Authentication failed","error")}}),d&&d.addEventListener("click",()=>{localStorage.removeItem("adminSecret"),localStorage.removeItem("tokenExpiry"),m(),u("Successfully logged out","success")}),r&&r.addEventListener("click",async()=>{const t=localStorage.getItem("adminSecret");if(!t)return void u("Please log in first","error");const n={name:document.getElementById("entryName").value,sketchfabLink:document.getElementById("sketchfabLink").value,mediafireLink:document.getElementById("mediafireLink").value,counterName:document.getElementById("counterName").value,fileSize:document.getElementById("fileSize").value,modelCount:document.getElementById("modelCount").value,uploadDate:document.getElementById("uploadDate").value,targetPage:document.getElementById("targetPage").value,isNew:document.getElementById("isNew").checked,isAnimated:document.getElementById("isAnimated").checked};if(n.name&&n.mediafireLink&&n.counterName)try{const o=await fetch(`https://api.github.com/repos/${e}/dispatches`,{method:"POST",headers:{Authorization:`Bearer ${t}`,Accept:"application/vnd.github.v3+json","Content-Type":"application/json","X-GitHub-Api-Version":"2022-11-28"},body:JSON.stringify({event_type:"update_downloads",client_payload:n})});if(!o.ok){const e=await o.text();let t=`HTTP ${o.status}`;try{t=JSON.parse(e).message||t}catch(t){console.warn("Failed to parse JSON response:",e)}throw new Error(t)}u("Entry submitted for processing!","success");["entryName","sketchfabLink","mediafireLink","counterName","fileSize","modelCount","uploadDate"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="")});const i=document.getElementById("targetPage");i&&(i.selectedIndex=0)}catch(e){console.error("Submission error:",e);let t=e.message;e instanceof SyntaxError?t="Invalid server response":e.message.includes("401")?t="Authentication failed - please log in again":e.message.includes("500")&&(t="Server error - please try again later"),u(`Submission failed: ${t}`,"error")}else u("Please fill all required fields","error")})});
